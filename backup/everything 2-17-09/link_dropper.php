<?phpsession_start();include_once('config/keys.php');require_once('config/db.php');// screen for whether they are logged inif ($_SESSION['user_id']=="") {	if ($_COOKIE['maintain'] != "") {		header("Location: config/login.php?x=login&jsoncallback=".$_REQUEST['jsoncallback']."page=link_dropper.php&return=login_dropper.php&user_id=".$_COOKIE['maintain']);	} else {		header("Location: config/login_dropper.php?page=link_dropper.php&return=login_dropper.php&jsoncallback=".$_REQUEST['jsoncallback']."");			exit;	}}// begin buffering output of the page.  later we'll handle where to output.ob_start();$target_group = '1';$URL = $_REQUEST['URL'];$title = $_REQUEST['title'];if ( $_REQUEST['page_id'] ) {	$page_id = ReturnSecureString($_REQUEST['page_id']);	$_SESSION['page_id'] = $page_id;} else {	$page_id = ReturnSecureString($_SESSION['page_id']);}if (! $_REQUEST['jsoncallback'] ) {?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" id="dropper_doc"><?php } ?><head>	<title>Add this link to your PageUI</title>	<meta name="generator" content="BBEdit 9.0" />	<script src="jquery-1.2.5.js"></script>	</head><body id="dropper_body" onunload="closeFrame();" ><h3 style="margin: 20px 0 0 10px;">Add to your PageUI</h3><img src="http://www.pageui.com/images/x-t.png" alt="close" title="close" id="close_button" style="position:fixed; top:30px; right:5%; z-index:10000004; margin:3px 30px 0 0; font-size:9px; border:1px solid #9EB847; padding:0; background:0; height:15px; width:15px" onclick="closeFrame();" />      	  	<div id="dropper_main" style="margin: 7px; padding: 4px; border: 1px #333 solid; min-width: 370px;">	<form action="javascript:updateLink();" method="post" id="new_link_form" name="new_link_form">		<table border="0" cellpadding="2">			<tr>				<td>Link / URL: </td>				<td><input name="URL" id="URL" type="text" size="40" maxlength="255" tabindex="1" value="<?php echo $URL ?>" /></td>				<td>Group: </td>				<td><select id="group_id" tabindex="3" name="group_id">					<!-- /// on elect of this option, hide new_link_form.new_group -->					<option label="add to a new group: " value="/new/" selected>add to a new group: </option>					<?php $sql = "call proc_GetGroupPageCombo(".$_SESSION['user_id'].")";						$errtxt .= '<br />'.$sql;						$resG = mysql_query($sql);						if (mysql_num_rows($resG)>0) {							echo '					<optgroup label="Your Groups">';							while ($r = mysql_fetch_assoc($resG)) { 														// determine whether to draw ' selected' label							if ( $r['id'] == $target_group)  {								$sel = ' selected';							} else {								$sel = '';							}							?>					<option label="<?php echo str_ireplace('@', '&nbsp;', str_pad($r['Title'], ($r['tlen']+1), '@', STR_PAD_RIGHT)) ?> - <?php echo $r['PageName'] ?>" value="<?php echo $r['id']?>-<?php echo $r['pid']?>" <?php echo $sel?>><?php echo str_pad($r['Title'], ($r['tlen']+1), ' ', STR_PAD_RIGHT) ?> - <?php echo $r['PageName'] ?></option>						<?php 	} ?>					</optgroup>				<?php							}						refreshDB();					?>					<optgroup label="System Groups">					<?php $sql = "SELECT G.id AS id, G.Title AS Title FROM Groups G WHERE GroupType_id = 2 ORDER BY G.Title";						$errtxt .= '<br/>'.$sql;						$resG = mysql_query($sql);						$errtxt .= '<br/> system groups, rows: '.mysql_num_rows ( $resG );						while ($r = mysql_fetch_assoc($resG)) {							// determine whether to draw ' selected' label							if ( $r['id'] == $target_group)  {								$sel = ' selected';							} else {								$sel = '';							}						?>						<option label="<?php echo $r['Title']?>" value="<?php echo $r['id'] ?>" <?php echo $sel?>><?php echo $r['Title']?></option><?php						}					?>					</optgroup>				</select>				</td>			</tr>			<tr>				<td>Title: </td>				<td><input name="title" id="title" type="text" size="35" maxlength="45" tabindex="2" value="<?php echo $title ?>" /></td>				<td></td>				<td width="155">					<input name="new_group" id="new_group" type="text" size="20" maxlength="30" tabindex="6" />				</td>				<td><input name="submit" type="submit" value="Add" /></td>			</tr>		</table>		<input name="row" id="row" type="hidden" size="2" maxlength="2" tabindex="4" value="<?php echo $row ?>" />		<input name="col" id="col" type="hidden" size="2" maxlength="2" tabindex="5" value="<?php echo $col ?>" />				<input name="proc" type="hidden" value="add" />		<input name="AJAX" type="hidden" value="1" />	</form>	</div><script type="text/javascript">// <![CDATA[	function updateLink() {		var getstr;		getstr = $("#new_link_form *").serialize().replace(/(group_id=\d+)-(\d+)/, '$1&page_id=$2') ;		loadFrame( 'http://www.pageui.com/test/config/links.php?' + getstr );		$("#dropper_frame").attr("style", "font-style:italic;text-align:center;padding-top:20px;");		setTimeout("closeFrame()", 1000);	}var old_f = document.onkeydown;$(document).keydown( function( e ) { 	switch (e.which) { 	case 27: // escape, close box 		// alert ('esc');		closeFrame();		document.onkeydown = old_f;		break;//	case 13: // escape, close box 	default:		//			}});// smooth UI for new group names$("#new_group").css( { display: "none" } );	$("#group_id").change(function () {	  var str = "";	  if ( $("#group_id option:selected").val() == '/new/') {			$("#new_group").slideDown(150);		  } else {			$("#new_group").slideUp(150);		  }	})	.change();$('#title').focus();// ]]></script></body><?php if (! $_REQUEST['jsoncallback'] ) {?></html><?php } // now that we have the full page, flush it to text or build the JSON and respond with it.if ( $_REQUEST['jsoncallback'] ) {	$arr = array( 'bigpage'=> ob_get_contents() );	$json_page = json_encode ( $arr );	// now that it's stored, dump everything generated	ob_clean();		header('Cache-Control: no-cache, must-revalidate');	header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');	header('Content-type: application/x-javascript');	// print the constructed JSON varbiable to the output buffer	echo $_REQUEST['jsoncallback']."(".$json_page.")";		// push it all to the client	ob_end_flush();	} else {	// or, just push it all to the client	ob_end_flush();	}?>